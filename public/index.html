<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Library Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }

        .top-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar h1 {
            font-size: 1.4em;
        }

        .stats-inline {
            display: flex;
            gap: 24px;
            font-size: 14px;
        }

        .stats-inline .stat {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-inline .stat-num {
            font-weight: 700;
            font-size: 18px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 16px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 16px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: transform 0.2s, opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button.secondary {
            background: #6c757d;
            padding: 8px 12px;
        }

        button.small {
            padding: 4px 8px;
            font-size: 11px;
        }

        input, select, textarea {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .filters-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .filters-row select {
            flex: 1;
            min-width: 0;
        }

        .book-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding: 4px;
        }

        .book-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
        }

        .book-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .book-cover {
            width: 100%;
            aspect-ratio: 2/3;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .book-cover-placeholder {
            color: #999;
            font-size: 36px;
        }

        .book-info {
            padding: 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .book-card h3 {
            color: #333;
            margin: 0 0 4px 0;
            font-size: 13px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .book-card .author {
            color: #666;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .book-card .bottom-row {
            margin-top: auto;
        }

        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .status-completed { background: #d4edda; color: #155724; }
        .status-reading { background: #fff3cd; color: #856404; }
        .status-want-to-read { background: #d1ecf1; color: #0c5460; }
        .status-on-hold { background: #e2e3e5; color: #383d41; }

        .ai-chat {
            height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
        }

        .ai-chat h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #333;
        }

        .book-context-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .book-context-banner .book-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .book-context-banner button {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            font-size: 11px;
            margin-left: 8px;
            flex-shrink: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 8px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.5;
        }

        .message.user {
            background: #667eea;
            color: white;
            margin-left: 30px;
        }

        .message.assistant {
            background: white;
            margin-right: 30px;
            border: 1px solid #e0e0e0;
        }

        /* Markdown content styling */
        .message.assistant p { margin-bottom: 8px; }
        .message.assistant p:last-child { margin-bottom: 0; }
        .message.assistant ul, .message.assistant ol { margin: 8px 0; padding-left: 20px; }
        .message.assistant li { margin-bottom: 4px; }
        .message.assistant strong { font-weight: 600; }
        .message.assistant h1, .message.assistant h2, .message.assistant h3 { margin: 12px 0 8px 0; }

        .suggestions-container {
            padding: 10px;
            background: #f0f4ff;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            margin-bottom: 8px;
        }

        .suggestions-container h4 {
            font-size: 11px;
            color: #667eea;
            margin-bottom: 6px;
        }

        .suggestion-btn {
            display: block;
            width: 100%;
            text-align: left;
            background: white;
            color: #333;
            padding: 6px 10px;
            margin-bottom: 4px;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }

        .suggestion-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .suggestion-btn:last-child { margin-bottom: 0; }

        .chat-input {
            display: flex;
            gap: 6px;
        }

        .chat-input input {
            flex: 1;
        }

        .message-container {
            position: relative;
        }

        /* Loading and error states */
        .message.loading {
            background: #f8f9fa;
            border: 1px dashed #ccc;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        .message.error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
        }

        .message.error .retry-btn {
            background: #c33;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            margin-left: 10px;
        }

        .chat-input button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .saved-qa-separator {
            display: flex;
            align-items: center;
            margin: 12px 0;
            color: #888;
            font-size: 11px;
        }

        .saved-qa-separator::before,
        .saved-qa-separator::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
        }

        .saved-qa-separator span {
            padding: 0 10px;
            white-space: nowrap;
        }

        .message.saved-qa-msg {
            opacity: 0.9;
            border-style: dashed;
        }

        .message.user.saved-qa-msg {
            background: #8a9be6;
        }

        .message.hidden-qa-msg {
            opacity: 0.5;
            background: #f5f5f5 !important;
            color: #888 !important;
        }

        .message.user.hidden-qa-msg {
            background: #d0d0d0 !important;
        }

        .qa-controls {
            display: flex;
            gap: 4px;
            margin-top: 6px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-container:hover .qa-controls {
            opacity: 1;
        }

        .qa-controls button {
            padding: 2px 8px;
            font-size: 10px;
            background: #6c757d;
        }

        .qa-controls .hide-btn { background: #ffc107; color: #333; }
        .qa-controls .unhide-btn { background: #28a745; }
        .qa-controls .delete-btn { background: #dc3545; }

        .hidden-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            background: #fff3cd;
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 12px;
            color: #856404;
        }

        .hidden-toggle button {
            padding: 4px 10px;
            font-size: 11px;
            background: #ffc107;
            color: #333;
        }

        /* Collapsible Q&A styles */
        .qa-item {
            margin-bottom: 8px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
            background: white;
        }

        .qa-item.hidden-qa {
            opacity: 0.6;
            border-style: dashed;
        }

        .qa-header {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            gap: 10px;
            transition: background 0.2s;
        }

        .qa-header:hover {
            opacity: 0.95;
        }

        .qa-header .expand-icon {
            font-size: 12px;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .qa-item.expanded .qa-header .expand-icon {
            transform: rotate(90deg);
        }

        .qa-header .question-text {
            flex: 1;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .qa-item.expanded .qa-header .question-text {
            white-space: normal;
        }

        .qa-body {
            display: none;
            padding: 12px;
            background: #f8f9fa;
            font-size: 13px;
            line-height: 1.6;
        }

        .qa-item.expanded .qa-body {
            display: block;
        }

        .qa-body p { margin-bottom: 8px; }
        .qa-body p:last-child { margin-bottom: 0; }
        .qa-body ul, .qa-body ol { margin: 8px 0; padding-left: 20px; }
        .qa-body li { margin-bottom: 4px; }
        .qa-body strong { font-weight: 600; }

        .qa-actions {
            display: flex;
            gap: 6px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .qa-actions button {
            padding: 4px 10px;
            font-size: 11px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 24px;
            border-radius: 8px;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-content h2 {
            margin-bottom: 16px;
            color: #333;
            font-size: 18px;
        }

        .modal-content input,
        .modal-content select {
            width: 100%;
            margin-bottom: 10px;
        }

        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .close-modal:hover { color: #333; }

        .loading {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 13px;
        }

        /* Book detail modal styles */
        .book-detail-header {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .book-detail-cover {
            width: 120px;
            height: 180px;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .book-detail-info h2 {
            margin: 0 0 8px 0;
            font-size: 18px;
        }

        .book-detail-info p {
            margin: 4px 0;
            font-size: 13px;
            color: #555;
        }

        .book-detail-info .tags {
            margin-top: 8px;
        }

        .book-detail-info .tag {
            display: inline-block;
            background: #e9ecef;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .content-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .content-section h3 {
            font-size: 14px;
            margin-bottom: 8px;
            color: #333;
        }

        .content-section p,
        .content-section .markdown-content {
            font-size: 13px;
            line-height: 1.6;
            color: #444;
        }

        .content-section .markdown-content p { margin-bottom: 8px; }
        .content-section .markdown-content p:last-child { margin-bottom: 0; }

        .saved-qa-section {
            margin-top: 12px;
            border-top: 1px solid #e0e0e0;
            padding-top: 12px;
        }

        .saved-qa-section h3 {
            font-size: 14px;
            margin-bottom: 10px;
        }

        .saved-qa-item {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .saved-qa-item .question {
            color: #667eea;
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 6px;
        }

        .saved-qa-item .answer {
            color: #333;
            font-size: 13px;
            line-height: 1.5;
        }

        .saved-qa-item .answer p { margin-bottom: 6px; }
        .saved-qa-item .answer p:last-child { margin-bottom: 0; }

        .saved-qa-item .qa-actions {
            margin-top: 6px;
            text-align: right;
        }

        .book-actions {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .delete-btn {
            background: #dc3545;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>AI Library Manager</h1>
        <div class="stats-inline" id="stats"></div>
    </div>

    <div class="container">
        <div class="main-content">
            <div class="card">
                <div class="controls">
                    <button onclick="showAddBookModal()">+ Add Book</button>
                    <button class="secondary" onclick="loadBooks()">Refresh</button>
                    <input type="text" id="searchInput" placeholder="Search books..." style="flex: 1; min-width: 150px;" onkeypress="if(event.key==='Enter')searchBooks()">
                    <button onclick="searchBooks()">Search</button>
                </div>
                <div class="filters-row">
                    <select id="filterStatus" onchange="applyFilters()">
                        <option value="">All Status</option>
                        <option value="want-to-read">Want to Read</option>
                        <option value="reading">Reading</option>
                        <option value="completed">Completed</option>
                        <option value="on-hold">On Hold</option>
                    </select>
                    <select id="filterGenre" onchange="applyFilters()">
                        <option value="">All Genres</option>
                    </select>
                    <select id="sortBy" onchange="applyFilters()">
                        <option value="dateAdded">Date Added</option>
                        <option value="title">Title</option>
                        <option value="author">Author</option>
                        <option value="publishedYear">Year</option>
                    </select>
                    <select id="sortOrder" onchange="applyFilters()" style="width: 80px;">
                        <option value="desc">Desc</option>
                        <option value="asc">Asc</option>
                    </select>
                </div>
                <div class="book-grid" id="bookGrid"></div>
            </div>

            <div class="card ai-chat">
                <h2>AI Assistant</h2>
                <div id="bookContextBanner" style="display: none;"></div>
                <div id="hiddenToggleContainer" style="display: none;"></div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        Hello! I can help you explore your library, get book recommendations, and answer questions about your books.
                    </div>
                </div>
                <div id="suggestionsContainer"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="Ask about your library..." onkeypress="handleChatKeyPress(event)">
                    <button onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="addBookModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('addBookModal')">&times;</span>
            <h2>Add New Book</h2>
            <p style="color: #666; margin-bottom: 12px; font-size: 13px;">Enter title and author. We'll fetch metadata automatically.</p>
            <input type="text" id="title" placeholder="Title *" required>
            <input type="text" id="author" placeholder="Author *" required>
            <input type="text" id="isbn" placeholder="ISBN (optional)">
            <select id="status">
                <option value="want-to-read">Want to Read</option>
                <option value="reading">Reading</option>
                <option value="completed">Completed</option>
                <option value="on-hold">On Hold</option>
            </select>
            <input type="text" id="tags" placeholder="Tags (comma-separated, optional)">
            <div id="addBookStatus" style="margin: 10px 0; color: #666; font-size: 13px;"></div>
            <button onclick="addBook()">Add Book</button>
        </div>
    </div>

    <div class="modal" id="viewBookModal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('viewBookModal')">&times;</span>
            <div id="bookDetails"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        // Simple markdown rendering function
        function renderMarkdown(text) {
            if (!text) return '';
            if (typeof marked !== 'undefined') {
                return marked.parse(text);
            }
            // Fallback: basic formatting
            return text
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/statistics`);
                const stats = await response.json();
                document.getElementById('stats').innerHTML = `
                    <div class="stat"><span class="stat-num">${stats.total}</span> Total</div>
                    <div class="stat"><span class="stat-num">${stats.completed}</span> Completed</div>
                    <div class="stat"><span class="stat-num">${stats.reading}</span> Reading</div>
                    <div class="stat"><span class="stat-num">${stats.wantToRead}</span> To Read</div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadBooks() {
            try {
                const response = await fetch(`${API_BASE}/books`);
                const data = await response.json();
                displayBooks(data.books);
            } catch (error) {
                console.error('Error loading books:', error);
            }
        }

        function displayBooks(books) {
            const grid = document.getElementById('bookGrid');
            if (books.length === 0) {
                grid.innerHTML = '<p class="loading">No books found. Add your first book!</p>';
                return;
            }

            grid.innerHTML = books.map(book => `
                <div class="book-card" onclick="viewBook(${book.id})">
                    <div class="book-cover">
                        ${book.coverUrl
                            ? `<img src="${book.coverUrl}" alt="${book.title}" loading="lazy">`
                            : `<div class="book-cover-placeholder">ðŸ“š</div>`}
                    </div>
                    <div class="book-info">
                        <h3>${escapeHtml(book.title)}</h3>
                        <p class="author">${escapeHtml(book.author)}</p>
                        <div class="bottom-row">
                            <span class="status-badge status-${book.status}">${book.status.replace(/-/g, ' ')}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function searchBooks() {
            const query = document.getElementById('searchInput').value;
            if (!query) {
                loadBooks();
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                displayBooks(data.books);
            } catch (error) {
                console.error('Error searching books:', error);
            }
        }

        // Store current book data for the askAboutBook function
        let currentViewedBook = null;

        async function viewBook(id) {
            try {
                const response = await fetch(`${API_BASE}/books/${id}`);
                const data = await response.json();
                const book = data.book;
                currentViewedBook = book;

                const tagsHtml = book.tags ? `
                    <div class="tags">
                        ${book.tags.split(',').map(tag => `<span class="tag">${escapeHtml(tag.trim())}</span>`).join('')}
                    </div>
                ` : '';

                document.getElementById('bookDetails').innerHTML = `
                    <div class="book-detail-header">
                        ${book.coverUrl ? `<img src="${book.coverUrl}" alt="${escapeHtml(book.title)}" class="book-detail-cover">` : ''}
                        <div class="book-detail-info">
                            <h2>${escapeHtml(book.title)}</h2>
                            <p><strong>Author:</strong> ${escapeHtml(book.author)}</p>
                            ${book.publishedYear ? `<p><strong>Published:</strong> ${book.publishedYear}</p>` : ''}
                            ${book.publisher ? `<p><strong>Publisher:</strong> ${escapeHtml(book.publisher)}</p>` : ''}
                            ${book.genre ? `<p><strong>Genre:</strong> ${escapeHtml(book.genre)}</p>` : ''}
                            ${book.pages ? `<p><strong>Pages:</strong> ${book.pages}</p>` : ''}
                            <p><span class="status-badge status-${book.status}">${book.status.replace(/-/g, ' ')}</span></p>
                            ${tagsHtml}
                        </div>
                    </div>
                    ${book.summary ? `
                        <div class="content-section">
                            <h3>Summary</h3>
                            <div class="markdown-content">${renderMarkdown(book.summary)}</div>
                        </div>
                    ` : ''}
                    ${book.description ? `
                        <div class="content-section">
                            <h3>Description</h3>
                            <div class="markdown-content">${renderMarkdown(book.description)}</div>
                        </div>
                    ` : ''}
                    <div id="savedQASection"></div>
                    <div class="book-actions">
                        <button onclick="askAboutCurrentBook()">Ask AI About This Book</button>
                        <button class="delete-btn" onclick="deleteBook(${book.id})">Delete Book</button>
                    </div>
                `;

                await loadSavedQA(book.id);
                document.getElementById('viewBookModal').classList.add('active');
            } catch (error) {
                console.error('Error viewing book:', error);
            }
        }

        async function askAboutCurrentBook() {
            if (!currentViewedBook) return;
            const book = currentViewedBook;

            currentBookContext = {
                id: book.id,
                title: book.title,
                author: book.author,
                summary: book.summary || '',
                genre: book.genre || '',
                tags: book.tags || ''
            };

            // Reset hidden state for new book context
            showHiddenQA = false;

            // Update banner
            const banner = document.getElementById('bookContextBanner');
            banner.style.display = 'block';
            banner.innerHTML = `
                <div class="book-context-banner">
                    <span class="book-title">Asking about: ${escapeHtml(book.title)}</span>
                    <button onclick="clearBookContext()">Clear</button>
                </div>
            `;

            // Clear chat and show initial message
            document.getElementById('chatMessages').innerHTML = `
                <div class="message assistant" id="bookIntroMsg">
                    I'm now focused on "<strong>${escapeHtml(book.title)}</strong>" by ${escapeHtml(book.author)}. What would you like to know?
                </div>
            `;

            // Load and display saved Q&A for this book
            await loadSavedQAInChat(book.id);

            // Generate context-aware suggestions based on saved Q&A
            await generateInitialSuggestions(book.id);

            closeModal('viewBookModal');
            document.getElementById('chatInput').focus();
        }

        async function generateInitialSuggestions(bookId) {
            // Get saved Q&A to avoid repeating questions
            try {
                const response = await fetch(`${API_BASE}/books/${bookId}/qa`);
                const data = await response.json();
                const savedQA = data.savedQA || [];

                // Default suggestions
                const defaultSuggestions = [
                    'What are the main themes?',
                    'Recommend similar books',
                    'Key takeaways from this book?',
                    'Who would enjoy this book?',
                    'What makes this book unique?',
                    'How does this compare to other books by the author?',
                    'What are the key arguments or ideas?',
                    'Is this book worth reading?'
                ];

                // Get questions that have already been asked (normalize for comparison)
                const askedQuestions = savedQA.map(qa => qa.question.toLowerCase().trim());

                // Filter out suggestions that are similar to already-asked questions
                const availableSuggestions = defaultSuggestions.filter(suggestion => {
                    const normalizedSuggestion = suggestion.toLowerCase().trim();
                    // Check if any asked question is similar
                    return !askedQuestions.some(asked => {
                        // Simple similarity check: contains key words
                        const suggestionWords = normalizedSuggestion.split(/\s+/);
                        const matchCount = suggestionWords.filter(word =>
                            word.length > 3 && asked.includes(word)
                        ).length;
                        return matchCount >= 2 || asked.includes(normalizedSuggestion) || normalizedSuggestion.includes(asked);
                    });
                });

                // Show up to 3 suggestions
                const suggestionsToShow = availableSuggestions.slice(0, 3);

                if (suggestionsToShow.length > 0) {
                    showSuggestions(suggestionsToShow);
                } else if (savedQA.length > 0) {
                    // All default suggestions have been asked, show more advanced ones
                    showSuggestions([
                        'What did I miss about this book?',
                        'Deeper analysis of the themes',
                        'How does this relate to current events?'
                    ]);
                } else {
                    showSuggestions(defaultSuggestions.slice(0, 3));
                }
            } catch (error) {
                console.error('Error generating suggestions:', error);
                // Fallback to default suggestions
                showSuggestions([
                    'What are the main themes?',
                    'Recommend similar books',
                    'Key takeaways from this book?'
                ]);
            }
        }

        let showHiddenQA = false;

        async function loadSavedQAInChat(bookId) {
            try {
                const includeHidden = showHiddenQA ? 'true' : 'false';
                const response = await fetch(`${API_BASE}/books/${bookId}/qa?includeHidden=${includeHidden}`);
                const data = await response.json();
                const savedQA = data.savedQA || [];
                const hiddenCount = data.hiddenCount || 0;

                // Update hidden toggle
                updateHiddenToggle(hiddenCount, bookId);

                const messagesDiv = document.getElementById('chatMessages');

                // Remove previous saved QA elements but keep the intro message
                const elementsToRemove = messagesDiv.querySelectorAll('.saved-qa-separator, .qa-item, .qa-container');
                elementsToRemove.forEach(el => el.remove());

                if (savedQA.length > 0) {
                    // Find the intro message to insert after
                    const introElement = document.getElementById('bookIntroMsg');

                    // Add a separator for saved Q&A
                    const separatorDiv = document.createElement('div');
                    separatorDiv.className = 'saved-qa-separator';
                    separatorDiv.innerHTML = `<span>Previously asked (${savedQA.length}) - click to expand</span>`;

                    if (introElement && introElement.nextSibling) {
                        messagesDiv.insertBefore(separatorDiv, introElement.nextSibling);
                    } else {
                        messagesDiv.appendChild(separatorDiv);
                    }

                    // Create container for collapsible Q&A items
                    const qaContainer = document.createElement('div');
                    qaContainer.className = 'qa-container';
                    separatorDiv.after(qaContainer);

                    // Add each saved Q&A as collapsible items
                    savedQA.forEach((qa, index) => {
                        const isHidden = qa.hidden === true;
                        const isLast = index === savedQA.length - 1;

                        const qaItem = document.createElement('div');
                        qaItem.className = `qa-item${isHidden ? ' hidden-qa' : ''}${isLast ? ' expanded' : ''}`;
                        qaItem.dataset.qaId = qa.id;

                        // Header (clickable question)
                        const header = document.createElement('div');
                        header.className = 'qa-header';
                        header.onclick = () => toggleQAExpand(qaItem);
                        header.innerHTML = `
                            <span class="expand-icon">â–¶</span>
                            <span class="question-text">${escapeHtml(qa.question)}</span>
                        `;

                        // Body (answer + controls)
                        const body = document.createElement('div');
                        body.className = 'qa-body';
                        body.innerHTML = renderMarkdown(qa.answer);

                        // Add actions
                        const actions = document.createElement('div');
                        actions.className = 'qa-actions';
                        if (isHidden) {
                            actions.innerHTML = `
                                <button class="unhide-btn" onclick="event.stopPropagation(); unhideQA(${qa.id}, ${bookId})">Unhide</button>
                                <button class="delete-btn" onclick="event.stopPropagation(); deleteQAFromChat(${qa.id}, ${bookId})">Delete</button>
                            `;
                        } else {
                            actions.innerHTML = `
                                <button class="hide-btn" onclick="event.stopPropagation(); hideQA(${qa.id}, ${bookId})">Hide</button>
                                <button class="delete-btn" onclick="event.stopPropagation(); deleteQAFromChat(${qa.id}, ${bookId})">Delete</button>
                            `;
                        }
                        body.appendChild(actions);

                        qaItem.appendChild(header);
                        qaItem.appendChild(body);
                        qaContainer.appendChild(qaItem);
                    });

                    // Add another separator before new chat
                    const endSeparatorDiv = document.createElement('div');
                    endSeparatorDiv.className = 'saved-qa-separator';
                    endSeparatorDiv.innerHTML = `<span>New conversation</span>`;
                    qaContainer.after(endSeparatorDiv);
                }

                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (error) {
                console.error('Error loading saved Q&A in chat:', error);
            }
        }

        function toggleQAExpand(qaItem) {
            const wasExpanded = qaItem.classList.contains('expanded');

            // Collapse all other items
            document.querySelectorAll('.qa-item.expanded').forEach(item => {
                item.classList.remove('expanded');
            });

            // Toggle this item (expand if it was collapsed)
            if (!wasExpanded) {
                qaItem.classList.add('expanded');
                // Scroll the expanded item into view
                qaItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function updateHiddenToggle(hiddenCount, bookId) {
            const container = document.getElementById('hiddenToggleContainer');
            if (hiddenCount > 0) {
                container.style.display = 'block';
                container.innerHTML = `
                    <div class="hidden-toggle">
                        <span>${hiddenCount} hidden Q&A${hiddenCount > 1 ? 's' : ''}</span>
                        <button onclick="toggleShowHidden(${bookId})">${showHiddenQA ? 'Hide them' : 'Show hidden'}</button>
                    </div>
                `;
            } else {
                container.style.display = 'none';
                container.innerHTML = '';
            }
        }

        async function toggleShowHidden(bookId) {
            showHiddenQA = !showHiddenQA;
            await loadSavedQAInChat(bookId);
        }

        async function hideQA(qaId, bookId) {
            try {
                const response = await fetch(`${API_BASE}/qa/${qaId}/hide`, { method: 'PUT' });
                if (!response.ok) {
                    console.error('Failed to hide Q&A:', response.status);
                    return;
                }
                // Remove from UI - works with both old message-container and new qa-item
                const qaItem = document.querySelector(`.qa-item[data-qa-id="${qaId}"]`);
                if (qaItem) {
                    qaItem.remove();
                }
                const container = document.querySelector(`.message-container[data-qa-id="${qaId}"]`);
                if (container) {
                    container.remove();
                }
                // Update hidden count and reload
                await loadSavedQAInChat(bookId);
            } catch (error) {
                console.error('Error hiding Q&A:', error);
            }
        }

        async function unhideQA(qaId, bookId) {
            try {
                const response = await fetch(`${API_BASE}/qa/${qaId}/unhide`, { method: 'PUT' });
                if (!response.ok) {
                    console.error('Failed to unhide Q&A:', response.status);
                    return;
                }
                // Reload the chat to show unhidden Q&A in proper order
                await loadSavedQAInChat(bookId);
            } catch (error) {
                console.error('Error unhiding Q&A:', error);
            }
        }

        async function updateHiddenCount(bookId) {
            try {
                const response = await fetch(`${API_BASE}/books/${bookId}/qa?includeHidden=true`);
                const data = await response.json();
                updateHiddenToggle(data.hiddenCount || 0, bookId);
            } catch (error) {
                console.error('Error updating hidden count:', error);
            }
        }

        async function deleteQAFromChat(qaId, bookId) {
            if (!confirm('Delete this Q&A?')) return;
            try {
                const response = await fetch(`${API_BASE}/qa/${qaId}`, { method: 'DELETE' });
                if (!response.ok) {
                    console.error('Failed to delete Q&A:', response.status);
                    return;
                }
                // Remove from UI - works with both old message-container and new qa-item
                const qaItem = document.querySelector(`.qa-item[data-qa-id="${qaId}"]`);
                if (qaItem) {
                    qaItem.remove();
                }
                const container = document.querySelector(`.message-container[data-qa-id="${qaId}"]`);
                if (container) {
                    container.remove();
                }
                // Update hidden count
                await updateHiddenCount(bookId);
            } catch (error) {
                console.error('Error deleting Q&A:', error);
            }
        }

        async function loadSavedQA(bookId) {
            try {
                const response = await fetch(`${API_BASE}/books/${bookId}/qa`);
                const data = await response.json();
                const savedQA = data.savedQA || [];

                const section = document.getElementById('savedQASection');
                if (savedQA.length > 0) {
                    section.innerHTML = `
                        <div class="saved-qa-section">
                            <h3>Saved Q&A</h3>
                            ${savedQA.map(qa => `
                                <div class="saved-qa-item">
                                    <div class="question">Q: ${escapeHtml(qa.question)}</div>
                                    <div class="answer">${renderMarkdown(qa.answer)}</div>
                                    <div class="qa-actions">
                                        <button class="small delete-btn" onclick="deleteSavedQA(${qa.id}, ${bookId})">Delete</button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    section.innerHTML = '';
                }
            } catch (error) {
                console.error('Error loading saved Q&A:', error);
            }
        }

        async function deleteSavedQA(qaId, bookId) {
            if (!confirm('Delete this saved Q&A?')) return;
            try {
                await fetch(`${API_BASE}/qa/${qaId}`, { method: 'DELETE' });
                await loadSavedQA(bookId);
            } catch (error) {
                console.error('Error deleting Q&A:', error);
            }
        }

        async function deleteBook(id) {
            if (!confirm('Delete this book?')) return;
            try {
                const response = await fetch(`${API_BASE}/books/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    closeModal('viewBookModal');
                    loadBooks();
                    loadStats();
                    loadFilters();
                }
            } catch (error) {
                console.error('Error deleting book:', error);
            }
        }

        async function addBook() {
            const book = {
                title: document.getElementById('title').value,
                author: document.getElementById('author').value,
                isbn: document.getElementById('isbn').value,
                status: document.getElementById('status').value,
                tags: document.getElementById('tags').value,
                fetchMetadata: true,
            };

            if (!book.title || !book.author) {
                alert('Title and Author are required!');
                return;
            }

            const statusDiv = document.getElementById('addBookStatus');
            statusDiv.innerHTML = 'Fetching metadata...';

            try {
                await fetch(`${API_BASE}/books`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(book),
                });

                statusDiv.innerHTML = 'Book added!';
                setTimeout(() => {
                    closeModal('addBookModal');
                    loadBooks();
                    loadStats();
                    loadFilters();
                    document.getElementById('title').value = '';
                    document.getElementById('author').value = '';
                    document.getElementById('isbn').value = '';
                    document.getElementById('tags').value = '';
                    statusDiv.innerHTML = '';
                }, 800);
            } catch (error) {
                statusDiv.innerHTML = 'Error adding book';
            }
        }

        // Book context state
        let currentBookContext = null;
        let lastQuestion = '';
        let lastAnswer = '';

        function clearBookContext() {
            currentBookContext = null;
            showHiddenQA = false;
            document.getElementById('bookContextBanner').style.display = 'none';
            document.getElementById('bookContextBanner').innerHTML = '';
            document.getElementById('hiddenToggleContainer').style.display = 'none';
            document.getElementById('hiddenToggleContainer').innerHTML = '';
            document.getElementById('suggestionsContainer').innerHTML = '';
            document.getElementById('chatMessages').innerHTML = `
                <div class="message assistant">
                    Hello! I can help you explore your library, get book recommendations, and answer questions about your books.
                </div>
            `;
        }

        function showSuggestions(suggestions) {
            const container = document.getElementById('suggestionsContainer');
            if (suggestions && suggestions.length > 0) {
                container.innerHTML = `
                    <div class="suggestions-container">
                        <h4>Try asking:</h4>
                        ${suggestions.map(s => `<button class="suggestion-btn" onclick="useSuggestion('${s.replace(/'/g, "\\'")}')">${escapeHtml(s)}</button>`).join('')}
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }

        function useSuggestion(text) {
            if (isProcessing) return;
            document.getElementById('chatInput').value = text;
            sendMessage();
        }

        let isProcessing = false;
        let lastRequestBody = null;

        async function sendMessage(retryMessage = null) {
            const input = document.getElementById('chatInput');
            const sendBtn = document.querySelector('.chat-input button');
            const message = retryMessage || input.value.trim();
            if (!message || isProcessing) return;

            isProcessing = true;
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            if (!retryMessage) {
                lastQuestion = message;
                addChatMessage('user', message);
                input.value = '';
            }
            document.getElementById('suggestionsContainer').innerHTML = '';

            // Show loading indicator
            const loadingId = showLoadingMessage();

            try {
                const requestBody = { message };
                if (currentBookContext) {
                    requestBody.bookContext = currentBookContext;
                }
                lastRequestBody = requestBody;

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s timeout

                const response = await fetch(`${API_BASE}/ai/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const data = await response.json();

                // Remove loading message
                removeLoadingMessage(loadingId);

                if (data.error) {
                    throw new Error(data.error);
                }

                lastAnswer = data.message;
                const messageContainer = addChatMessage('assistant', data.message);

                // Auto-save Q&A if in book context
                if (currentBookContext && lastQuestion && lastAnswer) {
                    const savedId = await autoSaveQA(data.suggestions);
                    if (savedId && messageContainer) {
                        addControlsToMessage(messageContainer, savedId, currentBookContext.id);
                    }
                }

                if (data.suggestions && data.suggestions.length > 0) {
                    showSuggestions(data.suggestions);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                removeLoadingMessage(loadingId);

                let errorMsg = 'Something went wrong. ';
                if (error.name === 'AbortError') {
                    errorMsg = 'Request timed out. The AI is taking too long to respond. ';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMsg = 'Network error. Please check your connection. ';
                } else if (error.message.includes('Server error')) {
                    errorMsg = 'Server error. Please try again. ';
                }

                showErrorMessage(errorMsg, message);
            } finally {
                isProcessing = false;
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
            }
        }

        function showLoadingMessage() {
            const messagesDiv = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            const loadingId = 'loading-' + Date.now();
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message loading';
            loadingDiv.innerHTML = `
                <div class="typing-indicator">
                    <span></span><span></span><span></span>
                </div>
                <span>AI is thinking...</span>
            `;
            messagesDiv.appendChild(loadingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return loadingId;
        }

        function removeLoadingMessage(loadingId) {
            const loadingDiv = document.getElementById(loadingId);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        function showErrorMessage(errorMsg, originalMessage) {
            const messagesDiv = document.getElementById('chatMessages');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message error';
            errorDiv.innerHTML = `
                <span>${escapeHtml(errorMsg)}</span>
                <button class="retry-btn" onclick="retryLastMessage('${originalMessage.replace(/'/g, "\\'")}')">Retry</button>
            `;
            messagesDiv.appendChild(errorDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function retryLastMessage(message) {
            // Remove the error message
            const errorMessages = document.querySelectorAll('.message.error');
            errorMessages.forEach(el => el.remove());
            // Retry the message
            sendMessage(message);
        }

        function addChatMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const containerDiv = document.createElement('div');
            containerDiv.className = 'message-container';

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            if (role === 'assistant') {
                messageDiv.innerHTML = renderMarkdown(content);
            } else {
                messageDiv.textContent = content;
            }

            containerDiv.appendChild(messageDiv);
            messagesDiv.appendChild(containerDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return containerDiv;
        }

        function addControlsToMessage(containerDiv, qaId, bookId) {
            containerDiv.dataset.qaId = qaId;
            const controls = document.createElement('div');
            controls.className = 'qa-controls';
            controls.innerHTML = `
                <button class="hide-btn" onclick="hideQA(${qaId}, ${bookId})">Hide</button>
                <button class="delete-btn" onclick="deleteQAFromChat(${qaId}, ${bookId})">Delete</button>
            `;
            containerDiv.appendChild(controls);
        }

        async function autoSaveQA(suggestions) {
            if (!currentBookContext || !lastQuestion || !lastAnswer) {
                return null;
            }

            try {
                const response = await fetch(`${API_BASE}/books/${currentBookContext.id}/qa`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question: lastQuestion,
                        answer: lastAnswer,
                        suggestions: suggestions ? JSON.stringify(suggestions) : null,
                    }),
                });
                const data = await response.json();
                // Store the saved QA ID for potential hide/delete actions
                lastSavedQAId = data.id;
                return data.id;
            } catch (error) {
                console.error('Error auto-saving Q&A:', error);
                return null;
            }
        }

        let lastSavedQAId = null;

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !isProcessing) sendMessage();
        }

        function showAddBookModal() {
            document.getElementById('addBookModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function loadFilters() {
            try {
                const [genresRes] = await Promise.all([
                    fetch(`${API_BASE}/genres`)
                ]);
                const genresData = await genresRes.json();
                const genreSelect = document.getElementById('filterGenre');
                genreSelect.innerHTML = '<option value="">All Genres</option>' +
                    genresData.genres.map(g => `<option value="${g}">${g}</option>`).join('');
            } catch (error) {
                console.error('Error loading filters:', error);
            }
        }

        async function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const genre = document.getElementById('filterGenre').value;
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;

            const params = new URLSearchParams();
            if (status) params.append('status', status);
            if (genre) params.append('genre', genre);
            if (sortBy) params.append('sortBy', sortBy);
            if (sortOrder) params.append('sortOrder', sortOrder);

            try {
                const response = await fetch(`${API_BASE}/books?${params.toString()}`);
                const data = await response.json();
                displayBooks(data.books);
            } catch (error) {
                console.error('Error applying filters:', error);
            }
        }

        loadStats();
        loadBooks();
        loadFilters();
    </script>
</body>
</html>
